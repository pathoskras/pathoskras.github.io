<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8">
    <meta http-equiv="x-ua-compatible" content="ie=edge">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>KRAS Annotation</title>
	<link rel="stylesheet" href="/css/main.css">
	<link rel="stylesheet" href="/canvas/canvas.css">
</head>

<body scroll="no" style="overflow: hidden">
    <h1>KRAS Annotation</h1>
{{#images}}
    <img style="display: none;" src="{{image}}">
{{/images}}



{{! {{#images}} }}
    <span id="controls">Controls</span>
    <canvas id="canvas-display" width="1000" height="700">
        
    </canvas>
    {{> controls}}
{{! {{/images}} }}


    <script src="/js/vendor.min.js"></script>
    <script type="text/javascript">
        {{! console.log("{{foo}}"); }}

        document.ontouchmove = function(event){
        event.preventDefault();
    }


        $(document).ready(function () {
            $('#canvas-display').paintBrush();

            setTimeout(function(){
                make_base();
            },1500);
        });

        var canvas = document.getElementById('canvas-display'),
        context = canvas.getContext('2d');


        function make_base()
        {
            console.log("making base");
            base_image = new Image();
            base_image.src = 'images/a.jpg';
            context.drawImage(base_image, 100, 100);
        }

    </script>
    <script>
        (function ($) {
            $.fn.paintBrush = function (options) {
                var undoHistory = [];
                var settings = {
                    'targetID': 'canvas-display'
                },

                    $this = $(this),
                    o = {},
                    ui = {},

                    core = {
                        init: function (options) {
                            ui.$loadParentDiv = o.targetID;
                            core.draw();
                            core.controls();
                            //core.toggleScripts();
console.log("hello");
                        },

                        canvasInit: function () {
console.log("canvasInit")
                            context = document.getElementById("canvas-display").getContext("2d");
                            context.lineCap = "round";
                            //Fill it with white background
                            context.save();
                            context.fillStyle = '#fff';
                            context.fillRect(0, 0, context.canvas.width, context.canvas.height);
                            context.restore();
                        },

                        saveActions: function () {
                            var imgData = document.getElementById("canvas-display").toDataURL("image/png");
                            undoHistory.push(imgData);
                            $('#undo').removeAttr('disabled');

                        },

                        undoDraw: function () {
                            if (undoHistory.length > 0) {
                                var undoImg = new Image();
                                $(undoImg).load(function () {
                                    var context = document.getElementById("canvas-display").getContext("2d");
                                    context.drawImage(undoImg, 0, 0);
                                });
                                undoImg.src = undoHistory.pop();
                                if (undoHistory.length == 0)
                                    $('#undo').attr('disabled', 'disabled');
                            }
                        },

                        draw: function () {
                            var canvas, cntxt, top, left, draw, draw = 0;
                            canvas = document.getElementById("canvas-display");
                            cntxt = canvas.getContext("2d");
                            top = $('#canvas-display').offset().top;
                            left = $('#canvas-display').offset().left;
                            core.canvasInit();

                            //Drawing Code
                            $('#canvas-display').mousedown(function (e) {
                                if (e.button == 0) {
                                    draw = 1;
                                    core.saveActions(); //Start The drawing flow. Save the state
                                    cntxt.beginPath();
                                    cntxt.moveTo(e.pageX - left, e.pageY - top);
                                } else {
                                    draw = 0;
                                }
                            })
                                .mouseup(function (e) {
                                    if (e.button != 0) {
                                        draw = 1;
                                    } else {
                                        draw = 0;
                                        cntxt.lineTo(e.pageX - left + 1, e.pageY - top + 1);
                                        cntxt.stroke();
                                        cntxt.closePath();
                                    }
                                })
                                .mousemove(function (e) {
                                    if (draw == 1) {
                                        cntxt.lineTo(e.pageX - left + 1, e.pageY - top + 1);
                                        cntxt.stroke();
                                    }
                                });

                        },

                        controls: function () {
                            canvas = document.getElementById("canvas-display");
                            cntxt = canvas.getContext("2d");


                            var button = document.getElementById('export');
                            $('#export').click(function (e) {
                                e.preventDefault();

                                var dataURL = canvas.toDataURL('image/png');
                                button.href = dataURL;
                                console.log(dataURL);
                                // window.open(canvas.toDataURL(), 'Canvas Export', 'height=400,width=400');
                            });

                            $('#clear').on("click", function (e) {
                                e.preventDefault();
                                canvas.width = canvas.width;
                                canvas.height = canvas.height;
                                core.canvasInit();
                                $('#colors li:first').click();
                                $('#brush_size').change();
                                //core.toggleScripts();
                                undoHistory = [];
                            });

                            $('#brush_size').change(function (e) {
                                cntxt.lineWidth = $(this).val();
                                //core.toggleScripts();
                            });

                            $('#colors li').on("click", function (e) {
                                e.preventDefault();
                                $('#colors li').removeClass('selected');
                                $(this).addClass('selected');
                                cntxt.strokeStyle = $(this).css('background-color');
                                core.toggleScripts();
                            });

                            //Undo Binding
                            $('#undo').on("click", function (e) {
                                e.preventDefault();
                                core.undoDraw()
                                core.toggleScripts();
                            });

                            //Init the brush and color
                            $('#colors li:first').click();
                            $('#brush_size').change();

                            $('#controls').on("click", function () {
                                core.toggleScripts();
                            });
                        },

                        toggleScripts: function () {
                            $('#colors').slideToggle(400);
                            $('#control-buttons').toggle(400);
                        }
                    };

                $.extend(true, o, settings, options);

                core.init();

            };



        })(jQuery);

        var download = function () {
            var link = document.createElement('a');
            link.download = 'filename.png';
            link.href = document.getElementById('canvas-display').toDataURL()
            link.click();
        }



    </script>
</body>

</html>